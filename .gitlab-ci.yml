before_script:
  - cd chess

stages:
  - lint
  - build
  - test
  - .post

lint-test-job:   # Test stage: Runs lint checks
  stage: lint
  script:
    - echo "Checking code style..."
    - mvn spotless:check
  tags:
      - shell

build-job:       # Build stage: Compiles the code and packages it into a JAR
  stage: build
  script:
    - echo "Starting Maven build..."
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - chess/target/  # Save build artifacts (e.g., JAR files) for use in later stages
  tags:
      - shell

unit-test-job:   # Test stage: Runs unit tests
  stage: test
  script:
    - echo "Running unit tests..."
    - mvn clean org.jacoco:jacoco-maven-plugin:prepare-agent test jacoco:report
    - cat target/site/jacoco/index.html
  artifacts:
    reports:
      junit: chess/target/surefire-reports/*.xml  # Ensure JUnit test results are visible in GitLab
      coverage_report:
        coverage_format: jacoco
        path: chess/target/site/jacoco/jacoco.xml
  coverage: '/Total.*?([0-9]{1,3})%/'
  tags:
      - shell

cleanup:
  stage: .post
  script:
    - mvn clean
  tags:
      - shell

